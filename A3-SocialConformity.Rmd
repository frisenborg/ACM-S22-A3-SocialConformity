---
title: "Assignment 3 - ACM-S22"
output: html_notebook
author: "Linnea, Melina, Orla, and Tobias"
---

# Description
The purpose for this assignment is to analyze real world data using Bayesian models of cogntion.  

The data comes from the social conformity experiment (https://pubmed.ncbi.nlm.nih.gov/30700729/), where cogsci students (in dataset 1) and schizophrenia patients + controls (dataset 2) combine their own intuition of trustworthiness of given faces to social information.

### Instructions
1. Implement (at least) 2 models: simple Bayes vs weighted Bayes (bonus points if you also include a GLM model).  
2. Fit the  models to one dataset (don't forget to explore the data first!)  
3. Check model quality  
4. Do model comparison  
5. Report (v minimal description of research question, v minimal description of data, description of models, model quality checks, report of results)  
6. [optional]: parameter/model recovery

### Guide to the social conformity data
Both datasets (students and schizophrenia) include the following columns:
- FaceID: an identifier of the specific face rated  
- ID: an identifier of the participant  
- Trial_Round1: in which trial the face was presented (during the first exposure)  
- Trial_Round2: in which trial the face was presented (during the second exposure)  
- FirstRating: the trustworthiness rating (1-8) given by the participant BEFORE seeing other ratings  
- OtherRating: the trustworthiness rating (1-8) given by others  
- SecondRating: the trustworthiness rating (1-8) given after seeing the others (at second exposure  

**The students dataset also includes:**  
- Change: the difference between the second and the first rating  
- Class: participants belong to two different cohorts (1 and 2) tested at different times - Feedback: the difference between other rating and own first rating  

**The schizophrenia dataset also includes:**  
- Group: 0 is comparison group, 1 is schizophrenia group 
- RT_Round1: time taken to produce the first rating of trustworthiness   
- RT_Round2: time taken to produce the second rating of trustworthiness  

The schizophrenia data was collected within the study described in *Simonsen, A., Fusaroli, R., Skewes, J. C., Roepstorff, A., Mors, O., Bliksted, V., & Campbell-Meiklejohn, D. (2019). Socially learned attitude change is not reduced in medicated patients with schizophrenia. Scientific reports, 9(1), 1-11.*

*The students data is currently unpublished.*

**Data:**  
- Student data: https://www.dropbox.com/s/r9917ta89qhwsl2/sc_students.csv?dl=0  
- Patient data: https://www.dropbox.com/s/td2oeos6kfrx7td/sc_schizophrenia.csv?dl=0  


```{r Setup, message=FALSE}

library(pacman)

pacman::p_load(tidyverse,
               here,
               posterior,
               cmdstanr,
               brms)

df <- read.csv("data/sc_schizophrenia.csv")


# Setup correct column for controls (ID's above 200)
df[df$ID > 200, "Group"] <- 0

# convert to 0 / 1
df$FirstRating_oh <- ifelse(df$FirstRating <= 4, 0.9, 0.1)
df$SecondRating_oh <- ifelse(df$SecondRating <= 4, 1, 0)
df$OtherRating_oh <- ifelse(df$OtherRating <= 4, 0.9, 0.1)

df_subset <- df %>% 
  subset(ID == 101)

df_multiagent_subset <- df %>% 
  subset(ID == 101 | ID == 103)



# Create scales for the ratings 
df_subset <- df_subset %>% mutate(FirstRating_c = rnorm(length(FirstRating), FirstRating * 9, 0) / 100,
                                  SecondRating_c= rnorm(length(SecondRating), SecondRating * 9, 0) / 100,
                                  OtherRating_c = rnorm(length(OtherRating), OtherRating * 9, 0) / 100)

df_multiagent_subset <- df_multiagent_subset %>% 
  mutate(FirstRating_c = rnorm(length(FirstRating), FirstRating * 9, 0) / 100,
         SecondRating_c= rnorm(length(SecondRating), SecondRating * 9, 0) / 100,
         OtherRating_c = rnorm(length(OtherRating), OtherRating * 9, 0) / 100)



```



```{r}

file <- file.path("stan_models/simpleBayes_binom.stan")
stan_model <- cmdstan_model(file)

data <- list(
  N       = length(df_subset$FirstRating_oh),
  y       = df_subset$SecondRating_oh,
  Source1 = df_subset$FirstRating_oh,
  Source2 = df_subset$OtherRating_oh)

# The following command calls Stan with specific options.
samples <- stan_model$sample(
  data = data,
  fixed_param = TRUE, 
  seed = 123,
  chains = 1,
  parallel_chains = 1,
  iter_warmup = 1000,
  iter_sampling = 2000,
  refresh = 500
)

samples$summary()


df_subset$likelihood<- exp(samples$summary()['mean'])

#samples$loo()

```


# Using continuous data 
```{r}

file_c <- file.path("stan_models/simpleBayes.stan")
stan_model <- cmdstan_model(file_c, cpp_options = list(stan__threads = TRUE))

trials = length(df_multiagent_subset$FirstRating_c)
agents = length(unique(df_multiagent_subset$ID))

data <- list(
  N       = trials,
  agents  = agents,
  y       = matrix(df_multiagent_subset$SecondRating_c, nrow=trials, ncol=agents),
  Source1 = matrix(df_multiagent_subset$FirstRating_c, nrow=trials, ncol=agents),
  Source2 = matrix(df_multiagent_subset$OtherRating_c, nrow=trials, ncol=agents))


# The following command calls Stan with specific options.
samples <- stan_model$sample(
  data = data,
  fixed_param = FALSE, 
  seed = 123,
  chains = 1,
  parallel_chains = 1,
  iter_warmup = 1000,
  iter_sampling = 2000,
  refresh = 500
)

# check the results 
samples$summary()





### THIS DOESNT WORK RIGHT NOW ###

# creating a dataframe for model predictions
prediction_df <- samples$summary() %>%
  subset(grepl("prediction", variable)) %>%
  mutate(prediction = mean / 9 * 100,
         true_rating = df_subset$SecondRating,
         trial = seq(length(variable))) %>%
  select(trial, true_rating, prediction)


# plotting the model predictions against true ratings
prediction_df %>%
  pivot_longer(cols=c("true_rating", "prediction")) %>%
  subset(trial < 30) %>%
  ggplot(aes(x = trial, y = value, color = name)) +
  geom_line()

# investigate error of model predictions
prediction_df <- prediction_df %>%
  mutate(error = abs(true_rating - prediction))

# print the summary stats
summary(prediction_df$error)
sd(prediction_df$error)

# inspect the loo
samples$loo()

```






```{r}

file_c <- file.path("stan_models/weightedBayes_multilevel.stan")
stan_model <- cmdstan_model(file_c, cpp_options = list(stan__threads = TRUE))

trials = length(df_multiagent_subset$FirstRating_c)
agents = length(unique(df_multiagent_subset$ID))

data <- list(
  trials  = trials,
  agents  = agents,
  choice  = matrix(df_multiagent_subset$SecondRating_c, nrow=trials, ncol=agents),
  source1 = matrix(df_multiagent_subset$FirstRating_c, nrow=trials, ncol=agents),
  source2 = matrix(df_multiagent_subset$OtherRating_c, nrow=trials, ncol=agents))

# The following command calls Stan with specific options.
samples <- stan_model$sample(
  data = data,
  fixed_param = FALSE, 
  seed = 123,
  chains = 1,
  parallel_chains = 1,
  iter_warmup = 1000,
  iter_sampling = 2000,
  refresh = 500
)


samples$summary()

```










